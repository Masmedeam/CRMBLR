{% extends "base.html" %}

{% block body_class %}page-workspace{% endblock %}
{% block main_class %}container container--fluid{% endblock %}

{% block content %}
  <div class="split">
    <section class="pane split-left">
      <div class="pane-header">Chat</div>
      <div class="pane-body">
        <div class="chat">
          <ul id="chat-messages" class="chat-messages" aria-live="polite">
            <li class="chat-msg bot">Welcome! Start typing to chat.</li>
          </ul>
          <form id="chat-form" class="chat-input" onsubmit="return false">
            <input id="chat-input" type="text" placeholder="Type a message…" autocomplete="off" aria-label="Chat input" />
            <button id="chat-send" type="button">Send</button>
          </form>
        </div>
      </div>
    </section>
    <aside class="pane split-right">
      <div class="pane-header">Voice Panel</div>
      <div class="pane-body">
        <p>Start a voice session with the Realtime API.</p>
        <button id="start-voice" type="button" class="btn">Start Voice</button>
        <button id="stop-voice" type="button" class="btn" style="display:none">Stop</button>
        <div style="margin-top:10px">
          <audio id="oai-audio" controls autoplay></audio>
        </div>
      </div>
    </aside>
  </div>

  <script>
    (function(){
      var list = document.getElementById('chat-messages');
      var input = document.getElementById('chat-input');
      var send = document.getElementById('chat-send');
      function addMessage(text, who){
        var li = document.createElement('li');
        li.className = 'chat-msg ' + (who || 'user');
        li.textContent = text;
        list.appendChild(li);
        list.parentElement.scrollTop = list.parentElement.scrollHeight;
      }
      function handleSend(){
        var text = (input.value || '').trim();
        if (!text) return;
        addMessage(text, 'user');
        input.value = '';
        // Placeholder echo until backend is wired
        setTimeout(function(){ addMessage('…', 'bot'); }, 100);
      }
      send.addEventListener('click', handleSend);
      input.addEventListener('keydown', function(e){ if (e.key === 'Enter') handleSend(); });
    })();
  </script>

  <script>
    (function(){
      var startBtn = document.getElementById('start-voice');
      var stopBtn = document.getElementById('stop-voice');
      var audioEl = document.getElementById('oai-audio');
      var pc = null; var dc = null; var ms = null;

      // Gate: require JWT in localStorage
      var token = localStorage.getItem('crmb_lr_jwt');
      if (!token){ window.location.href = '/login'; return; }

      async function startVoice(){
        try {
          startBtn.disabled = true;
          // Get ephemeral key from server
          const tokenResp = await fetch('/token', { headers: { Authorization: 'Bearer ' + token }});
          if (!tokenResp.ok){ throw new Error('Failed to fetch token'); }
          const data = await tokenResp.json();
          const EPHEMERAL_KEY = data && (data.value || data.client_secret || data.token || data.key);
          if (!EPHEMERAL_KEY){ throw new Error('No ephemeral key returned'); }

          pc = new RTCPeerConnection();
          // Remote audio playback
          pc.ontrack = (e) => { audioEl.srcObject = e.streams[0]; };

          // Local mic
          ms = await navigator.mediaDevices.getUserMedia({ audio: true });
          pc.addTrack(ms.getTracks()[0]);

          // Data channel
          dc = pc.createDataChannel('oai-events');
          dc.addEventListener('open', () => console.log('DataChannel open'));
          dc.addEventListener('message', (e) => {
            try { console.log('Server event:', JSON.parse(e.data)); } catch(_) { console.log('Server event:', e.data); }
          });

          // Start SDP exchange
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          const baseUrl = 'https://api.openai.com/v1/realtime/calls';
          const model = 'gpt-realtime';
          const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
            method: 'POST',
            body: offer.sdp,
            headers: { Authorization: `Bearer ${EPHEMERAL_KEY}`, 'Content-Type': 'application/sdp' },
          });
          const answer = { type: 'answer', sdp: await sdpResponse.text() };
          await pc.setRemoteDescription(answer);

          stopBtn.style.display = '';
          startBtn.style.display = 'none';
        } catch (err){
          console.error(err);
          alert('Voice session failed: ' + err.message);
          startBtn.disabled = false;
        }
      }

      async function stopVoice(){
        try {
          if (dc){ dc.close(); dc = null; }
          if (pc){ pc.close(); pc = null; }
          if (ms){ ms.getTracks().forEach(t => t.stop()); ms = null; }
        } finally {
          stopBtn.style.display = 'none';
          startBtn.style.display = '';
          startBtn.disabled = false;
        }
      }

      startBtn.addEventListener('click', startVoice);
      stopBtn.addEventListener('click', stopVoice);
    })();
  </script>
{% endblock %}
