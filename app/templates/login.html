{% extends "base.html" %}

{% block body_class %}page-login{% endblock %}
{% block main_class %}container container--fluid{% endblock %}

{% block content %}
  <div class="split">
    <section class="pane split-left">
      <div class="pane-body" style="display:flex; align-items:center; justify-content:center;">
        <div style="max-width:480px; padding:16px; text-align:center">
          <div style="width:100%; height:180px; background:#f3f4f6; border:1px solid var(--border); border-radius:12px; margin-bottom:16px"></div>
          <h1 style="margin:0 0 8px;">Welcome to CRMBLR</h1>
          <p style="color:var(--muted); margin:0">Build conversational CRM workflows with a split-screen workspace and voice.</p>
        </div>
      </div>
    </section>
    <aside class="pane split-right">
      <div class="pane-header">Sign in / Sign up</div>
      <div class="pane-body">
        <p>Continue with Google or email.</p>
        <div id="g_id_onload"
             data-client_id="{{ google_client_id }}"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="onGoogleCredential"
             data-itp_support="true">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="signin_with" data-shape="rect" data-logo_alignment="left"></div>

        <hr style="margin: 20px 0; border:0; border-top:1px solid var(--border)" />

        <div>
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button id="tab-signin" class="btn" type="button">Sign in</button>
            <button id="tab-signup" class="btn" type="button">Sign up</button>
          </div>
          <form id="form-signin" onsubmit="return false" style="display:block; max-width:360px">
            <input id="si-email" type="email" placeholder="Email" required style="width:100%; padding:10px; margin:6px 0; border:1px solid var(--border); border-radius:8px" />
            <input id="si-password" type="password" placeholder="Password" required style="width:100%; padding:10px; margin:6px 0; border:1px solid var(--border); border-radius:8px" />
            <button id="btn-signin" class="btn" type="button">Sign in</button>
          </form>
          <form id="form-signup" onsubmit="return false" style="display:none; max-width:360px">
            <input id="su-name" type="text" placeholder="Name (optional)" style="width:100%; padding:10px; margin:6px 0; border:1px solid var(--border); border-radius:8px" />
            <input id="su-email" type="email" placeholder="Email" required style="width:100%; padding:10px; margin:6px 0; border:1px solid var(--border); border-radius:8px" />
            <input id="su-password" type="password" placeholder="Password" required style="width:100%; padding:10px; margin:6px 0; border:1px solid var(--border); border-radius:8px" />
            <button id="btn-signup" class="btn" type="button">Create account</button>
          </form>
        </div>
      </div>
    </aside>
  </div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    async function onGoogleCredential(resp){
      try {
        const r = await fetch('/auth/google', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ credential: resp.credential })
        });
        if (!r.ok){ throw new Error('Auth failed'); }
        const data = await r.json();
        if (!data || !data.token){ throw new Error('No token returned'); }
        localStorage.setItem('crmb_lr_jwt', data.token);
        window.location.href = '/';
      } catch (e) {
        alert('Login failed: ' + (e.message || e));
      }
    }
    (function(){
      var tabSignin = document.getElementById('tab-signin');
      var tabSignup = document.getElementById('tab-signup');
      var formSignin = document.getElementById('form-signin');
      var formSignup = document.getElementById('form-signup');
      function show(which){
        formSignin.style.display = which === 'in' ? 'block' : 'none';
        formSignup.style.display = which === 'up' ? 'block' : 'none';
      }
      tabSignin.addEventListener('click', function(){ show('in'); });
      tabSignup.addEventListener('click', function(){ show('up'); });

      async function signin(){
        var email = document.getElementById('si-email').value.trim();
        var password = document.getElementById('si-password').value;
        const r = await fetch('/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
        const data = await r.json();
        if (!r.ok){ alert(data.error || 'Sign in failed'); return; }
        localStorage.setItem('crmb_lr_jwt', data.token);
        window.location.href = '/';
      }
      async function signup(){
        var email = document.getElementById('su-email').value.trim();
        var password = document.getElementById('su-password').value;
        var name = document.getElementById('su-name').value.trim();
        const r = await fetch('/auth/signup', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password, name }) });
        const data = await r.json();
        if (!r.ok){ alert(data.error || 'Sign up failed'); return; }
        localStorage.setItem('crmb_lr_jwt', data.token);
        window.location.href = '/';
      }
      document.getElementById('btn-signin').addEventListener('click', signin);
      document.getElementById('btn-signup').addEventListener('click', signup);
    })();
  </script>
{% endblock %}
